<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NutriAxis — Личный кабинет</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>NutriAxis — Личный кабинет</h1>
    <button onclick="logout()">Выйти</button>
  </header>
  <main>
    <div id="userInfo" style="margin-bottom:2rem;"></div>
    <hr>
    <h3>Последний расчёт КБЖУ:</h3>
    <div id="lastCalculation"></div>
    <button onclick="location.href='index.html'">Рассчитать заново</button>
    <hr>
    <h3>Последний анализ рациона:</h3>
    <div id="lastAnalyze"></div>
    <button onclick="location.href='analyze.html'">Новый анализ</button>
  </main>
  <footer>
    <a href="/legal/disclaimer.html">Отказ от ответственности</a> |
    <a href="/legal/privacy.html">Политика конфиденциальности</a> |
    <a href="/legal/terms.html">Условия использования</a>
  </footer>
  <script>
    // Firebase config (тот же, что и на остальных)
    const firebaseConfig = {
      apiKey: "AIzaSyCptJ1iTweRdZE3hxaepb6Wx2rdhTCYfDo",
      authDomain: "bba-creator.firebaseapp.com",
      projectId: "bba-creator",
      storageBucket: "bba-creator.appspot.com",
      messagingSenderId: "141640866350",
      appId: "1:141640866350:web:bca3f1d2278165837e1dbf",
      measurementId: "G-FEKG0B970P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        window.location.href = "auth.html";
        return;
      }
      // Информация о пользователе
      document.getElementById('userInfo').innerHTML =
        `<b>Email:</b> ${user.email}<br><b>UID:</b> ${user.uid}`;
      // Последний расчёт (если уже реализовано сохранение)
      try {
        const calcSnap = await db.collection('users').doc(user.uid)
          .collection('calculations').orderBy('date', 'desc').limit(1).get();
        if (!calcSnap.empty) {
          const c = calcSnap.docs[0].data();
          document.getElementById('lastCalculation').innerHTML =
            `Дата: ${c.date || "?"}<br>Калории: ${c.calories} ккал<br>Б:${c.protein} Ж:${c.fat} У:${c.carbs}`;
        } else {
          document.getElementById('lastCalculation').innerHTML = "Нет данных.";
        }
      } catch (e) {
        document.getElementById('lastCalculation').innerHTML = "Ошибка загрузки расчётов.";
      }
      // Последний анализ
      try {
        const anSnap = await db.collection('users').doc(user.uid)
          .collection('analyzes').orderBy('date', 'desc').limit(1).get();
        if (!anSnap.empty) {
          const a = anSnap.docs[0].data();
          document.getElementById('lastAnalyze').innerHTML =
            `Дата: ${a.date || "?"}<br>Описание: ${a.foodText || "Фото"}`;
        } else {
          document.getElementById('lastAnalyze').innerHTML = "Нет данных.";
        }
      } catch (e) {
        document.getElementById('lastAnalyze').innerHTML = "Ошибка загрузки анализов.";
      }
    });

    function logout() {
      firebase.auth().signOut().then(() => window.location.href = "auth.html");
    }
  </script>
</body>
</html>
